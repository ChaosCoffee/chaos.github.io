---
title: Java内存区域
comments: false
date: 2018-08-13 10:08:17
categories: JVM
tags: JVM
img: 
---
# 运行时数据区域
<!-- TOC -->

- [运行时数据区域](#运行时数据区域)
- [运行时数据区模块图](#运行时数据区模块图)
    - [Java堆](#java堆)
        - [从内存回收角度上看](#从内存回收角度上看)
        - [从内存分配角度看](#从内存分配角度看)
        - [扩展](#扩展)
        - [异常](#异常)
    - [方法区](#方法区)
        - [运行时常量池](#运行时常量池)
            - [字面量](#字面量)
            - [符号引用](#符号引用)
        - [方法区异常](#方法区异常)
        - [配置](#配置)
    - [Java虚拟机栈](#java虚拟机栈)
        - [栈帧](#栈帧)
            - [局部变量表](#局部变量表)
            - [操作数栈](#操作数栈)
            - [动态链接](#动态链接)
            - [方法出口](#方法出口)
        - [栈异常](#栈异常)
    - [本地方法栈](#本地方法栈)
    - [程序计数器](#程序计数器)
    - [直接内存](#直接内存)

<!-- /TOC -->

# 运行时数据区模块图
![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/Java_memory_area_division.png)



## Java堆
Java虚拟机规范:  
> 所有的对象实例及数组都要在堆上分配

### 从内存回收角度上看
- 新生代
  - Eden
  - From Survivor
  - To Survivor
- 老年代
  
### 从内存分配角度看
可划分出多个线程私有的分配缓冲区(`Thread Local Allocation Buffer,TLAB)

### 扩展
- -Xmx 最大堆内存
- -Xms 初始化堆内存
- -Xmn 新生代内存
- -XX:SurvivorRatio=8 定义了新生代的Eden区域一个Survivor区的空间比例是8:1

### 异常
堆中没有内存完成实例分配,并且堆也无法再扩展时候，抛出`OutOfMemoryError`异常


## 方法区
jdk8之前, JVM用`永久代(Permanent Generation)`存放方法区 ,方法区逻辑上属于堆的一部分

存储信息包括以下:  
- 类信息
- 常量
- 静态变量
- 即时编译器编译后的代码等数据

### 运行时常量池
Class文件除了有类的版本，字段，方法，接口等描述信息，还有常量池。
> 常量池用于存放编译器生成的各种`字面量`和`符号引用`。
除了保存Class文件中描述的符号引用外，翻译出来的直接引用也会存储在运行时常量池中。
特性: 动态性，常量不一定只有编译器产生，运行期间也可以将新的常量放入池中

#### 字面量
- 文本字符串
- 声明为final的常量值
  
#### 符号引用
> 符号引用指的是以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只需使用时能无歧义的定位到目标即可  

符号引用包括以下三类常量:
- 类和接口的全限定名
- 字段的名称和描述符
- 方法的名称和描述符  
  
Class文件中不会保存各个方法、字段的最终内存布局信息, 字段或方法的符号引用需要经过运行期转换得到真正的内存入口地址，然后被虚拟机使用。
当虚拟机运行时，需要从常量池获取对于的符号引用，在类创建或者运行时`解析`(解析阶段是虚拟机将常量池的符号引用替换为`直接引用`的过程),翻译到具体的内存地址中。

> 直接引用 直接指向目标的指针，相对偏移量或者一个可以间接定位到目标的句柄

### 方法区异常
无法满足内存分配需求时候，将抛出OutOfMemoryError异常

### 配置
jdk7
-XX:PermSize=10M
-XX:MaxPermGen=10M

jdk8: 
> `Metaspace` 元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。因此，默认情况下，元空间的大小仅受本地内存限制，但可以通过以下参数来指定元空间的大小：

> -XX:MetaspaceSize 初始空间大小
> -XX:MaxMetaspaceSize 最大空间，默认是没有限制的。

[元空间介绍](https://blog.csdn.net/guhong5153/article/details/70196354)

## Java虚拟机栈
> 生命周期与线程相同

### 栈帧
每个方法执行时创建一个`栈帧`,用于存储局部变量表，操作数栈，动态链接，方法出口等信息。
每一个方法从调用至完成的过程，对应着一个栈帧在虚拟机栈中入栈到出栈的过程。

#### 局部变量表
- 基本数据类型(boolean,byte,char,short,int,float,long,double)
- 对象引用(`reference类型`,它不等同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或者其他与此对象相关的位置)
- returnAddress类型(指向一条字节码指令的地址)
  
#### 操作数栈

#### 动态链接

#### 方法出口

### 栈异常
- 线程请求的栈深度大于虚拟机所允许的深度，抛出StackOverflowError异常
- 虚拟机栈动态扩展时无法申请到足够的内存，抛出OutOfMemoryError异常

## 本地方法栈


## 程序计数器


## 直接内存