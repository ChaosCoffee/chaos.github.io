---
title: 搭建个人博客教程(三)
comments: false
date: 2018-09-10 16:56:25
categories: blog
tags: hexo
img:
---
# 搭建个人博客教程(三)
这一篇是利用`GitHub`进行托管访问,提交代码自动部署访问,省去每次都要本地搭建一套环境的麻烦事.
<!-- TOC -->

- [搭建个人博客教程(三)](#搭建个人博客教程三)
    - [创建仓库](#创建仓库)
    - [域名配置](#域名配置)
    - [访问](#访问)
    - [持续集成&部署](#持续集成部署)
    - [Travis CI介绍](#travis-ci介绍)
        - [Travis CI准备工作](#travis-ci准备工作)
        - [编写.travis.yml脚本](#编写travisyml脚本)
        - [查看Travis CI工作](#查看travis-ci工作)
    - [扩展](#扩展)
    - [总结](#总结)

<!-- /TOC -->
## 创建仓库
到[GitHub](https://github.com/)上新建一个仓库.点击仓库`Settings`可以看到相关配置信息.  
**名称必须要使用{username}.github.io格式规范**  


![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/hexo-github1.png)  


![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/hexo-github2.png)  


## 域名配置
这一步,没有域名的同学可以不要.根目录下创建`CNAME`文件,里面填写域名名称,然后去相应云厂商DNS解析，也有免费的`https://www.dnspod.cn/`

## 访问
提交你的代码到master分支,然后访问`https://chaoscoffee.github.io/`或者`域名`就能展示和本地一样的界面了.

## 持续集成&部署  

## Travis CI介绍
这里介绍一下进阶的用法,我们编写博客只是为了写一些文章放上面,中间繁琐的配置和搭建环境希望省略而不是每一次换一个机器都要重新搭建一次. 
这里`CI`的好处就出来了.  


> Travis CI 提供的是持续集成服务（Continuous Integration，简称 CI）。它绑定 Github 上面的项目，只要有新的代码，就会自动抓取。然后，提供一个运行环境，执行测试，完成构建，部署到服务器。

这里提供了免费版本: `https://travis-ci.org/`  
也可以用企业版本,私有的(收费) `https://travis-ci.com/`  

所以接下来预期目标就是提交代码到`GitHub`上,然后`Travis CI`帮我们创建Hexo环境生成，编译之类的.只需要提交一篇博客文章就可以打开浏览器看到效果.

### Travis CI准备工作
`https://travis-ci.org/`创建账户，这里直接使用`GitHub账户`登录，这样`Travis CI`可以拉取到所有的仓库，对你要发布的仓库置为开启状态.  

![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-1.png)  

点击`setting`显示如下:  

![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-2.png)  


### 编写.travis.yml脚本
既然想要`Travis CI`做我们想做的事情，那就需要实现告知它要干啥.这里需要在`Github`仓库根路径下创建`.travis.yml`执行脚本.
其实这个脚本实现的内容很简单，第一个是监听分支，然后更新运行`Hexo`环境,然后提交给master分支代码.

1. 创建分支
根据以上描述，我们需要建立一个新分支，建立所有分支如下  
- master 
- hexo #Hexo源文件分支

1. 编写脚本
创建脚本`.travis.yml`放到根目录下.  

``` yml
language: node_js #设置环境
node_js: stable

sudo: false

#cache
cache:
  directories:
    - "node_modules" #缓存目录

notifications:
  email:
    recipients:
      - chaos183@163.com  #通知邮箱
    on_success: change
    on_failure: always

# S: Build Lifecycle
install:
  - npm install
#  - gem install travis
#  - travis login --pro --github-token ${GH_TOKEN}

before_script: #准备工作
  - export TZ='Asia/Shanghai'
  - npm install -g gulp # 这是压缩格式css,js等文件插件，可以不要
  - chmod +x _travis.sh # 赋予权限

script: #执行脚本
  - hexo clean && hexo g # hexo 生成
  - gulp # 执行gulp命令,可以不需要

after_success:
 # - LAST_BUILD_NUMBER=68
 # - for i in $(seq 1 $LAST_BUILD_NUMBER ); do  travis logs $i --delete --force ; done

after_script:
  - ./_travis.sh #执行shell,见下面贴出

# E: Build LifeCycle

branches:
  only:
    - hexo #只监听这个分支代码
env:
 global:
   - GH_REF: github.com/ChaosCoffee/ChaosCoffee.github.io.git #全局变量仓库地址
```

下面就是拉取仓库地址,提交代码的脚本了`_travis.sh`,也可以把下面的shell搬到上面文件一起。  

``` sh
#!/bin/bash
#定义时间
time=`date +%Y-%m-%d\ %H:%M:%S`

#执行成功
function success(){
   echo "success"
}

#执行失败
function failure(){
   echo "failure"
}

#默认执行
function default(){

  git clone https://${GH_REF} .deploy_git
  cd .deploy_git

  git checkout master
  cd ../

  mv .deploy_git/.git/ ./public/
  cd ./public

cat <<EOF >> build-log.md
部署状态 | 集成结果 | 参考值
---|---|---
完成时间 | $time | yyyy-mm-dd hh:mm:ss
部署环境 | $TRAVIS_OS_NAME + $TRAVIS_NODE_VERSION | window \| linux + stable
部署类型 | $TRAVIS_EVENT_TYPE | push \| pull_request \| api \| cron
启用Sudo | $TRAVIS_SUDO | false \| true
仓库地址 | $TRAVIS_REPO_SLUG | owner_name/repo_name
提交分支 | $TRAVIS_COMMIT | hash 16位
提交信息 | $TRAVIS_COMMIT_MESSAGE |
Job ID   | $TRAVIS_JOB_ID |
Job NUM  | $TRAVIS_JOB_NUMBER |
EOF

  git init
  git config user.name "ChaosCoffee"
  git config user.email "1104855822@qq.com"
  git add .
  git commit -m "update blog by travis-ci with build version $TRAVIS_BUILD_NUMBER"
  # Github Pages
  git push --force --quiet "https://${GH_TOKEN}@${GH_REF}" master:master # 这里的GH_TOKEN后面会介绍，相当于预置的一个环境变量
  # Create Tag
  #git tag v1.2.$TRAVIS_BUILD_NUMBER -a -m "Auto Taged By TravisCI With Build $TRAVIS_BUILD_NUMBER"
  # Github Pages
  #git push --quiet "https://${GH_TOKEN}@${GH_REF}" master:master --tags
}

case $1 in
    "success")
         success
       ;;
    "failure")
         failure
         ;;
             *)
       default
esac

```

3. 配置Token和环境变量
上面脚本用到了`GH_TOKEN`这个变量,其实是一个`GitHub`的权限Token,这个是私有的，不想让其他人看见，否则任何人都能提交到你的仓库里了.
首先到`GitHub`上配置`personal access token`.

3.1 新建Token  

![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-3.png)  

3.2 给`Token`相应权限

![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-4.png)  


**注意：这里生成Token值记得保存下来，不然再重新打开页面就看不到了**

3.3 `Travis CI`环境变量  
`travis ci` 仓库`setting`里配置 `GH_TOKEN`,这样环境变量配置工作全部都完成了.

![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-5.png)  

4. 参考
可以参考我的配置,改动下自己的仓库地址和环境变量,分支就行了.  
[.travis.yml](https://github.com/ChaosCoffee/ChaosCoffee.github.io/blob/hexo/.travis.yml)  
[_travis.sh](https://github.com/ChaosCoffee/ChaosCoffee.github.io/blob/hexo/_travis.sh)

### 查看Travis CI工作
这里可以在控制台看到对面Job运行.  
![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-6.png)   

Job构建历史记录  
![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-7.png)  

## 扩展
很多项目有这个结果反馈图标，可以通过`Travis CI`提供的Job情况来看到，注意选择`hexo`分支，否则会看到`unknown`.  

![image](https://raw.githubusercontent.com/ChaosCoffee/ChaosCoffee.github.io/master/img/CI-8.png)  


## 总结
这里总结一下历经步骤,GitHub上创建`hexo`源文件分支，提交代码到`Hexo`分支,`Travis CI`监听到变化，根据`_travis-ci.yml`脚本运行Job,持续集成运行环境,将生成的博客代码提交到默认的`master`分支上.
最后可以直接可以访问域名或者默认地址即可.  
以后想写文章，每次只需要提交markdown文件到`hexo`分支上,本地不需要任何环境配置.